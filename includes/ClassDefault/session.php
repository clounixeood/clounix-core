<?php
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function pnSessionSetup()
{

    $path = pnGetBaseURI();
    
    if (empty($path)) { $path = '/'; }
    
    $host = preg_replace('/:.*/', '', $_SERVER['HTTP_HOST']);

    ini_set('session.use_trans_sid', 0);
    ini_set('session.save_handler', 'user');
    ini_set('session.serialize_handler', 'php');
    ini_set('session.use_cookies', 1);
    ini_set('session.name', COOKIE_NAME);
    ini_set('session.cookie_lifetime', 86400);
    ini_set('session.gc_probability', 1);
    ini_set('session.gc_maxlifetime', COOKIE_DURATA_MINUTI * 60);
    ini_set('session.auto_start', 1);
    
    if (version_compare(phpversion(), '5.2.0', '>=')) { register_shutdown_function('session_write_close');  }     
    
    session_set_save_handler("pnSessionOpen","pnSessionClose","pnSessionRead","pnSessionWrite","pnSessionDestroy","pnSessionGC");
    
    return true;

}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function pnSessionGetVar($name)
{
    if (isset($name) && isset($_SESSION['MDSV' . $name])) { return $_SESSION['MDSV' . $name]; } else { return false; }
      
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 
function pnSessionSetVar($name, $value)
{
    if (!isset($name)) { return false; }
    
    //Imposto la variabile
    $_SESSION['MDSV' . $name] = $value;

    return true;
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function pnSessionGetFormVar($name)
{
    if(isset($name) && isset($_SESSION['form_' . $name])) { return $_SESSION['form_' . $name]; } else { return false; }
} 
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function pnSessionSetFormVar($name, $value)
{
    if (!isset($name)) return false;

    //Imposto la variabile
    $_SESSION['form_'.$name] = $value;

    return true;
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function pnSessionDelFormVars()
{

  foreach ($_SESSION as $key=>$value) {
  
  if (substr($key, 0, 5) == 'form_') {
  
    unset($_SESSION[$key]);
    unset($GLOBALS[$key]);  
  
  }  
  }
    return true;
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function pnSessionDelVar($name)
{

	if (empty($name) || !(isset($_SESSION)) || !(isset($_SESSION['MDSV' . $name]) || !isset($GLOBALS['MDSV' . $name]))){
		return false;
	}

    unset($_SESSION['MDSV' . $name]);
    unset($GLOBALS['MDSV' . $name]);

    return true;
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function pnSessionInit()
{
    //Parametro global
    global $mysqli;

    foreach($GLOBALS as $k => $v) {  if (preg_match('/^MDSV/', $k)) { return false; } }
    
    //Inizio con la sessione
    session_start();

    Header('Cache-Control: cache');

    $sessid = session_id();
    
    //Prendo ip address
    $ipaddr = $_SERVER['REMOTE_ADDR'];
    
    // indirizzo vuoto provo metodo alternativo
    if (empty($ipaddr)) { $ipaddr = getenv('REMOTE_ADDR'); }
    
    // indirizzo vuoto provo metodo alternativo    
    if (!empty($_SERVER['HTTP_CLIENT_IP'])) { $ipaddr = $_SERVER['HTTP_CLIENT_IP']; }
    
    $tmpipaddr = getenv('HTTP_CLIENT_IP');
    
    if (!empty($tmpipaddr)) { $ipaddr = $tmpipaddr;}
    if (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) { $ipaddr = preg_replace('/,.*/', '', $_SERVER['HTTP_X_FORWARDED_FOR']); }
    
    $tmpipaddr = getenv('HTTP_X_FORWARDED_FOR');
    
    if (!empty($tmpipaddr)) { $ipaddr = preg_replace('/,.*/', '', $tmpipaddr); }

    //Query per recuperare la sessione
    $result = $mysqli->query("SELECT pn_ipaddr FROM _session_info WHERE pn_sessid = '".$sessid."'");

    if (!$result) { return false; }
    
    if ($result->num_rows > 0) {
    
        
        //Prendo la sessione corrente
        pnSessionCurrent($sessid);
    
    } else {
  
        
        //apro una nuova sessione
        pnSessionNew($sessid, $ipaddr); 
        
        //Numero casuale
        srand((double)microtime() * 1000000); 
        
        //IMposto il numero casuale
        pnSessionSetVar('rand', rand());    
    
    }
    
    return true;
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function pnSessionCurrent($sessid)
{

    //Parametro global
    global $mysqli;
    
    $query = $mysqli->query("UPDATE _session_info SET pn_lastused=".time()." WHERE pn_sessid='".$sessid."'");
    
    //Se non trovo la query ritorno falso
    if (!$query) { return false; } else { return true; }
   
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function pnSessionNew($sessid, $ipaddr)
{

    //Parametro global
    global $mysqli;
    
    $query = $mysqli->query("INSERT INTO _session_info (pn_sessid, pn_ipaddr, pn_uid, pn_firstused, pn_lastused) VALUES ('".$sessid."', '".$ipaddr."', 0, ".time().",".time().")");    

    //Se non trovo la query ritorno falso
    if (!$query) { return false; } else { return true; }
 
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function pnSessionOpen($path, $name)
{
    // Nothing to do - database opened elsewhere
    return true;
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function pnSessionClose()
{
    // Nothing to do - database closed elsewhere
    return true;
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function pnSessionRead($sessid)
{

    //Parametro global
    global $mysqli;

    $query = $mysqli->query("SELECT pn_vars FROM _session_info WHERE pn_sessid = '".$sessid."' LIMIT 1");

    //Se la query non va a buon fine
    if (!$query) { return false; }

    //Se ci sono risultati 
    if ($query->num_rows > 0) {
    
    //Li assegno alla variabile values
    $value = $query->fetch_row();
    
    //altrimenti
    } else {
    
    //Variabile uguale a vuoto
    $value = '';
    
    }   

    return($value[0]);
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function pnSessionWrite($sessid, $vars)
{

    //Parametro global
    global $mysqli;

    $q = $mysqli->query("UPDATE _session_info SET pn_vars='".$vars."' WHERE pn_sessid='".$sessid."'");
    
    //Se la query non va a buon fine
    if (!$q) { return false; } else { return true; }
 
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function pnSessionDestroy($sessid)
{

    //Parametro global
    global $mysqli;

    $q = $mysqli->query("DELETE FROM _session_info WHERE pn_sessid='".$sessid."'");
    
    //Se la query non va a buon fine
    if (!$q) { return false; } else { return true; }
       
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function pnSessionGC($maxlifetime)
{
    
    //Parametro global
    global $mysqli;

    $q = $mysqli->query("DELETE FROM _session_info WHERE pn_lastused < '".(time() - (COOKIE_DURATA_MINUTI * 60))."'");

    //Se la query non va a buon fine
    if (!$q) { return false; } else { return true; }
      
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
?>
